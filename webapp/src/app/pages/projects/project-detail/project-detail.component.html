<div class="project-detail-container">
  @if (isLoading) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading project details...</p>
    </div>
  }

  @if (!isLoading && !project) {
    <div class="error-container">
      <mat-icon color="warn">error</mat-icon>
      <h2>Project Not Found</h2>
      <p>The project you're looking for doesn't exist or has been removed.</p>
      <button mat-raised-button routerLink="/projects">
        Browse Available Projects
      </button>
    </div>
  }

  @if (!isLoading && project) {
    <mat-card class="project-card">
      <mat-card-header>
          <mat-card-title>
                <div>
                  <button mat-button class="backButton" routerLink="/projects">
                      <mat-icon>arrow_back</mat-icon> Back to Projects
                  </button>
                </div>
              <h4 class="project-title-row mt-2">
                  {{ project.title }}
              </h4>
          </mat-card-title>
        <mat-card-subtitle>
          @if (project.serve_lead) {
            <div class="lead-subtitle">
              <span class="lead-label">Serve Day Lead:</span>
              <span>{{ project.serve_lead.first_name }} {{ project.serve_lead.last_name }}</span>
              <span><a href="mailto:{{ project.serve_lead.email }}">{{project.serve_lead.email}}</a></span>
            </div>
          }
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="project-dates">
          <div class="date-field">
            <strong>Date:</strong> {{ serve_date | date:'fullDate' }}
          </div>
          <div class="date-field">
            <strong>Time:</strong> {{ project.time }}
          </div>
        </div>

          @if (!myproject) {
              <div class="mt-2">
                  <button
                          mat-raised-button
                          class="darkbutton"
                          (click)="openRegistrationForm()"
                          [disabled]="loadingRegistration || isProjectFull()"
                  >
                      <mat-icon>event_available</mat-icon>
                      <span>Register</span>
                  </button>
              </div>
          }


        <div class="project-capacity">
          <h6>Registration Capacity</h6>
          <div class="capacity-indicator">
            <div class="capacity-bar-container">
              <div
                class="capacity-bar"
                [ngClass]="{
                  available: getCapacityPercentage() < 50,
                  filling:
                    getCapacityPercentage() >= 50 &&
                    getCapacityPercentage() < 80,
                  'almost-full':
                    getCapacityPercentage() >= 80 &&
                    getCapacityPercentage() < 100,
                  full: getCapacityPercentage() >= 100,
                }"
                [style.width.%]="getCapacityPercentage()"
              ></div>
            </div>
            <span class="capacity-text">
              {{ project.current_registrations }} /
              {{ project.max_capacity }} spots filled
            </span>
          </div>
        </div>

        <div class="project-description">
          <h6>About This Project</h6>
          <div class="full-description">
            <p><span [innerHTML]="project.rich_description ? project.rich_description : project.description"></span></p>
          </div>
        </div>

        @if (project.categories && project.categories.length > 0) {
        <div class="project-tools">
          <mat-chip-set>
            @for (category of project.categories; track category.id) {
            <mat-chip>{{ categories[category.id] }}</mat-chip>
            }
          </mat-chip-set>
        </div>
        }

        @if (project.ages && project.ages.length > 0) {
        <div class="project-tools">
          <h3>Ages Needed</h3>
          <mat-chip-set>
            @for (age of project.ages; track age.id) {
            <mat-chip>{{ ages[age.id] }}</mat-chip>
            }
          </mat-chip-set>
        </div>
        }

        <!-- Area Section - Only shown if lat/long is provided -->
        @if (project.latitude && project.longitude) {
          <div class="project-area">
            @if (project.area) {
              <p><strong>Location:</strong> {{ project.area }}</p>
            }

            @if (project.latitude && project.longitude) {
              <!-- Google Maps component -->
              <div class="map-container">
                <google-map [options]="mapOptions" height="300px" width="100%">
                  @if (markerPosition) {
                    <map-marker
                      [position]="markerPosition"
                      [options]="markerOptions"
                    ></map-marker>
                  }
                </google-map>
              </div>

              <div class="map-actions">
                <a
                  href="https://maps.google.com/?q={{ project.latitude }},{{
                    project.longitude
                  }}"
                  target="_blank"
                  mat-raised-button
                  class="getDirections"
                >
                  <mat-icon>directions</mat-icon> Get Directions
                </a>
              </div>
            }
          </div>
        }

        <div class="registration-status">
          @if (myproject) {
            <div class="registered-message">
              <mat-icon color="primary">check_circle</mat-icon>
              <span>You are registered for this project</span>
            </div>
          }

          @if (registrationError) {
            <div class="error-message">
              <mat-icon color="warn">error</mat-icon>
              <span>{{ registrationError }}</span>
            </div>
          }
        </div>
      </mat-card-content>

      <mat-card-actions align="end">
        <button mat-button class="backButton" routerLink="/projects">
          <mat-icon>arrow_back</mat-icon> Back to Projects
        </button>

        @if (!myproject) {
          <button
            mat-raised-button
            class="darkbutton"
            (click)="openRegistrationForm()"
            [disabled]="loadingRegistration || isProjectFull()"
          >
            <mat-icon>event_available</mat-icon>
            <span>Register</span>
          </button>
        } @else {
          <button
            mat-raised-button
            class="darkbutton"
            (click)="openEditGuestCountDialog()"
            [disabled]="true || loadingRegistration"
            disabled
          >
            <mat-icon>edit</mat-icon>
            <span>Edit Registration</span>
          </button>
        }

        @if (myproject) {
          <button
            mat-raised-button
            color="warn"
            (click)="openCancellationDialog()"
            [disabled]="true || loadingRegistration"
          >
            <mat-icon>event_busy</mat-icon>
            @if (!loadingRegistration) {
              <span>Cancel Registration</span>
            }
            @if (loadingRegistration) {
              <span>Cancelling...</span>
            }
          </button>
        }

  <!-- Cancellation Dialog Template -->
  <ng-template #cancellationDialog>
    <div class="cancellation-dialog">
      <h2 mat-dialog-title>Cancel Registration</h2>
      <mat-dialog-content>
        <p>Are you sure you want to cancel your registration for {{ project.title }}?</p>
      </mat-dialog-content>
      <mat-dialog-actions align="end">
        <button mat-button mat-dialog-close>No, Keep Registration</button>
        <button mat-raised-button color="warn" (click)="confirmCancellation()">
          Yes, Cancel Registration
        </button>
      </mat-dialog-actions>
    </div>
  </ng-template>
      </mat-card-actions>
    </mat-card>

    <!-- Admin Panel - Only visible to admins -->
    @if (isAdmin | async) {
      @if (project) {
      <app-admin-project-panel [project_id]="project.id"></app-admin-project-panel>
      }
    }
  }
</div>