<div class="project-detail-container">
  @if (isLoading) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading project details...</p>
    </div>
  }

  <!-- Registration Dialog Template -->
  <ng-template #registrationDialog>
    <div class="registration-dialog">
      <h2 mat-dialog-title>Register for {{ project?.title }}</h2>

      <mat-dialog-content>
        <form #registrationForm="ngForm">
          <mat-form-field class="full-width">
            <mat-label>First Name</mat-label>
            <input
              matInput
              type="text"
              [(ngModel)]="first_name"
              name="first_name"
              required
            />
          </mat-form-field>

          <mat-form-field class="full-width">
            <mat-label>Last Name</mat-label>
            <input
              matInput
              type="text"
              [(ngModel)]="last_name"
              name="last_name"
              required
            />
          </mat-form-field>
          <mat-form-field class="full-width">
            <mat-label>Phone Number</mat-label>
            <input
              matInput
              type="tel"
              [(ngModel)]="phone"
              name="phone"
              required
            />
            <mat-hint>Enter your contact phone number</mat-hint>
          </mat-form-field>

          <mat-form-field class="full-width">
            <mat-label>Contact Email</mat-label>
            <input
              matInput
              type="email"
              [(ngModel)]="email"
              name="email"
              required
            />
            <mat-hint>Enter your contact email</mat-hint>
          </mat-form-field>

          <mat-form-field class="full-width">
            <mat-label>Number of guests</mat-label>
            <input
              matInput
              type="number"
              min="0"
              max="10"
              [(ngModel)]="guest_count"
              name="guest_count"
            />
            <mat-hint>Enter the number of guests (not including yourself) you'll bring (0-10)</mat-hint>
          </mat-form-field>

          <mat-checkbox
            [(ngModel)]="lead_interest"
            name="lead_interest"
            class="project-lead-checkbox"
          >
            I am interested in being a project lead
          </mat-checkbox>

          <p class="lead-description">
            Project leads help coordinate activities and may receive additional
            instructions before the project starts.
          </p>
        </form>
      </mat-dialog-content>

      <mat-dialog-actions align="end">
        <button mat-button mat-dialog-close>Cancel</button>
        <button
          mat-raised-button
          color="primary"
          [disabled]="loadingRegistration"
          (click)="registerForProject()"
        >
          @if (!loadingRegistration) {
            <span>Complete Registration</span>
          }
          @if (loadingRegistration) {
            <span>Processing...</span>
          }
        </button>
      </mat-dialog-actions>
    </div>
  </ng-template>

  @if (!isLoading && project) {
    <mat-card class="project-card">
      <mat-card-header>

        <mat-card-title>
          <button mat-button color="accent" routerLink="/projects">
            <mat-icon>arrow_back</mat-icon> Back to Projects
          </button>
          <div>{{ project.title }}</div>
          </mat-card-title>
        <mat-card-subtitle>
          <div class="date-subtitle">
            @if (getDaysUntilStart() > 0) {
              <span>
                Starting in {{ getDaysUntilStart() }} days ({{
                  formatDate(project.project_date)
                }})
              </span>
            }
            @if (getDaysUntilStart() === 0) {
              <span> Starting today! </span>
            }
            @if (getDaysUntilStart() < 0) {
              <span> Started {{ -getDaysUntilStart() }} days ago </span>
            }
          </div>
          @if (project.lead_user) {
            <div class="lead-subtitle">
              <span class="lead-label">Project Lead:</span>
              <span>{{ project.lead_user.first_name }} {{ project.lead_user.last_name }}</span>
              <span>{{ project.lead_user.phone }}</span>
              <span>{{ project.lead_user.email }}</span>
            </div>
          }
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="project-dates">
          <div class="date-field">
            <strong>Date:</strong> {{ formatDate(project.project_date) }}
          </div>
          <div class="date-field">
            <strong>Time:</strong> {{ project.time }}
          </div>
        </div>

        <div class="project-capacity">
          <h3>Registration Capacity</h3>
          <div class="capacity-indicator">
            <div class="capacity-bar-container">
              <div
                class="capacity-bar"
                [ngClass]="{
                  available: getCapacityPercentage() < 50,
                  filling:
                    getCapacityPercentage() >= 50 &&
                    getCapacityPercentage() < 80,
                  'almost-full':
                    getCapacityPercentage() >= 80 &&
                    getCapacityPercentage() < 100,
                  full: getCapacityPercentage() >= 100,
                }"
                [style.width.%]="getCapacityPercentage()"
              ></div>
            </div>
            <span class="capacity-text">
              {{ project.current_registrations }} /
              {{ project.max_capacity }} spots filled
            </span>
          </div>
        </div>

        <div class="project-description">
          <h3>About This Project</h3>
          <div class="short-description">
            <h4>Summary</h4>
            <p>{{ project.short_description }}</p>
          </div>
          <div class="full-description">
            <h4>Full Description</h4>
            <p>{{ project.description }}</p>
          </div>
          <div class="accessibility-info">
            <mat-icon [class.accessible]="project.wheelchair_accessible">
              {{
                project.wheelchair_accessible ? "accessible" : "not_accessible"
              }}
            </mat-icon>
            <span
              >This location is
              {{ project.wheelchair_accessible ? "" : "not " }}wheelchair
              accessible</span
            >
          </div>
        </div>

        @if (project.categories && project.categories.length > 0) {
        <div class="project-tools">
          <h3>Categories</h3>
          <mat-chip-set>
            @for (category of project.categories; track category.id) {
            <mat-chip>{{ categories[category.id] }}</mat-chip>
            }
          </mat-chip-set>
        </div>
        }

        @if (project.ages && project.ages.length > 0) {
        <div class="project-tools">
          <h3>Ages Needed</h3>
          <mat-chip-set>
            @for (age of project.ages; track age.id) {
            <mat-chip>{{ ages[age.id] }}</mat-chip>
            }
          </mat-chip-set>
        </div>
        }

        @if (project.tools && project.tools.length > 0) {
          <div class="project-tools">
            <h3>Tools Needed</h3>
            <mat-chip-set>
              @for (tool of project.tools; track tool.id) {
                <mat-chip>{{ tools[tool.id] }}</mat-chip>
              }
            </mat-chip-set>
          </div>
        }

        @if (project.supplies && project.supplies.length > 0) {
        <div class="project-tools">
          <h3>Supplies Needed</h3>
          <mat-chip-set>
            @for (supply of project.supplies; track supply.id) {
            <mat-chip>{{ supplies[supply.id] }}</mat-chip>
            }
          </mat-chip-set>
        </div>
        }

        <!-- Location Section - Only shown if location is provided -->
        @if (project.location_name || (project.latitude && project.longitude)) {
          <div class="project-location">
            <h3>Location</h3>
            @if (project.location_name) {
              <p><strong>Location:</strong> {{ project.location_name }}</p>
            }

            @if (project.latitude && project.longitude) {
              <!-- Google Maps component -->
              <div class="map-container">
                <google-map [options]="mapOptions" height="300px" width="100%">
                  @if (markerPosition) {
                    <map-marker
                      [position]="markerPosition"
                      [options]="markerOptions"
                    ></map-marker>
                  }
                </google-map>
              </div>

              <div class="map-actions">
                <a
                  href="https://maps.google.com/?q={{ project.latitude }},{{
                    project.longitude
                  }}"
                  target="_blank"
                  mat-raised-button
                  color="accent"
                >
                  <mat-icon>directions</mat-icon> Get Directions
                </a>
              </div>
            }
          </div>
        }

        <div class="registration-status">
          @if (isRegistered) {
            <div class="registered-message">
              <mat-icon color="primary">check_circle</mat-icon>
              <span>You are registered for this project</span>
            </div>
          }

          @if (registrationError) {
            <div class="error-message">
              <mat-icon color="warn">error</mat-icon>
              <span>{{ registrationError }}</span>
            </div>
          }
        </div>
      </mat-card-content>
      <h2>TODO - DIALOG BOX FOR CANCELLING</h2>
      <mat-card-actions align="end">
        <button mat-button color="accent" routerLink="/projects">
          <mat-icon>arrow_back</mat-icon> Back to Projects
        </button>

        @if (!isRegistered) {
          <button
            mat-raised-button
            color="primary"
            (click)="openRegistrationForm()"
            [disabled]="loadingRegistration || isProjectFull()"
          >
            <mat-icon>event_available</mat-icon>
            <span>Register</span>
          </button>
        }

        @if (isRegistered) {
          <button
            mat-raised-button
            color="warn"
            (click)="cancelRegistration()"
            [disabled]="loadingRegistration"
          >
            <mat-icon>event_busy</mat-icon>
            @if (!loadingRegistration) {
              <span>Cancel Registration</span>
            }
            @if (loadingRegistration) {
              <span>Cancelling...</span>
            }
          </button>
        }
      </mat-card-actions>
    </mat-card>

    <!-- Admin Panel - Only visible to admins -->
    @if (isAdmin) {
      <mat-card class="admin-panel">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>admin_panel_settings</mat-icon>
            Admin Panel - Registrations
          </mat-card-title>
        </mat-card-header>

        <mat-card-content>
          @if (registrations && registrations.length === 0) {
            <div class="no-registrations">
              <p>No registrations found for this project.</p>
            </div>
          }

          @if (registrations && registrations.length > 0) {
            <div class="registrations-table-container">
              <table
                mat-table
                [dataSource]="registrationsDataSource"
                class="registrations-table"
              >
                <!-- Name Column -->
                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef>Name</th>
                  <td mat-cell *matCellDef="let reg">
                    {{ reg.user?.first_name }} {{ reg.user?.last_name }}
                    <!--                    //TODO: not correct-->
                    @if (reg.lead_interest) {
                      <span class="project-lead-badge">Project Lead</span>
                    }
                  </td>
                </ng-container>

                <!-- Email Column -->
                <ng-container matColumnDef="email">
                  <th mat-header-cell *matHeaderCellDef>Email</th>
                  <td mat-cell *matCellDef="let reg">{{ reg.user?.email }}</td>
                </ng-container>

                <!-- Phone Column -->
                <ng-container matColumnDef="phone">
                  <th mat-header-cell *matHeaderCellDef>Phone</th>
                  <td mat-cell *matCellDef="let reg">{{ reg.user?.phone }}</td>
                </ng-container>

                <!-- Registration Date Column -->
                <ng-container matColumnDef="registrationDate">
                  <th mat-header-cell *matHeaderCellDef>Registration Date</th>
                  <td mat-cell *matCellDef="let reg">
                    {{ formatDate(reg.created_at) }}
                    @if (reg.guest_count > 0) {
                      <span class="guest-badge"
                        >+{{ reg.guest_count }} guests</span
                      >
                    }
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="registrationsColumns"></tr>
                <tr
                  mat-row
                  *matRowDef="let row; columns: registrationsColumns"
                ></tr>
              </table>
            </div>
          }
        </mat-card-content>
      </mat-card>
    }
  }

  @if (!isLoading && !project) {
    <div class="error-container">
      <mat-icon color="warn">error</mat-icon>
      <h2>Project Not Found</h2>
      <p>The project you're looking for doesn't exist or has been removed.</p>
      <button mat-raised-button color="primary" routerLink="/projects">
        Browse Available Projects
      </button>
    </div>
  }
</div>
