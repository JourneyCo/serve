<div class="project-form-container">
  <h2 mat-dialog-title>{{ dialogTitle }}</h2>

  @if (!loading) {
  <form [formGroup]="projectForm" (ngSubmit)="onSubmit()">
    <mat-dialog-content>
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Project Title</mat-label>
          <input
                  matInput
                  formControlName="title"
                  placeholder="Enter project title"
                  required
          />
          @if (projectForm.get("title")?.hasError("required")) {
          <mat-error> Title is required </mat-error>
          }
          @if (projectForm.get("title")?.hasError("maxlength")) {
          <mat-error> Title cannot exceed 100 characters </mat-error>
          }
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Short Description</mat-label>
          <textarea
                  matInput
                  formControlName="short_description"
                  placeholder="Enter a brief summary"
                  rows="2"
                  required
          ></textarea>
          @if (projectForm.get("short_description")?.hasError("required")) {
          <mat-error> Short description is required </mat-error>
          }
          @if (projectForm.get("short_description")?.hasError("maxlength")) {
          <mat-error>
            Short description cannot exceed 200 characters
          </mat-error>
          }
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Full Description</mat-label>
          <textarea
                  matInput
                  formControlName="description"
                  placeholder="Enter detailed project description"
                  rows="4"
                  required
          ></textarea>
          @if (projectForm.get("description")?.hasError("required")) {
          <mat-error> Description is required </mat-error>
          }
          @if (projectForm.get("description")?.hasError("minlength")) {
          <mat-error> Description must be at least 10 characters </mat-error>
          }
        </mat-form-field>
      </div>

      <div class="form-row time-row">
        <mat-form-field appearance="outline">
          <mat-label>Time</mat-label>
          <textarea
                  matInput
                  formControlName="time"
                  placeholder="Enter a period of time (9:00AM - 9:30AM)"
                  rows="1"
                  required
          ></textarea>
          @if (projectForm.get("time")?.hasError("required")) {
          <mat-error> Time is required </mat-error>
          }
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Maximum Capacity</mat-label>
          <input
                  matInput
                  type="number"
                  formControlName="max_capacity"
                  min="1"
                  max="1000"
                  required
          />
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Lead User</mat-label>
          <mat-select formControlName="lead_user_id" required>
            @for (user of sortedUsers; track user.id) {
            <mat-option [value]="user.id"
            >{{ user.last_name }}, {{ user.first_name }}</mat-option
            >
            }
          </mat-select>
          @if (projectForm.get("lead_user_id")?.hasError("required")) {
          <mat-error> Lead User is required </mat-error>
          }
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Tools</mat-label>
        <mat-select formControlName="tools" multiple>
          @for (key of toolKeys; track key) {
          <mat-option [value]="+key">{{ toolList[+key] }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Skills</mat-label>
        <mat-select formControlName="skills" multiple>
          @for (key of skillKeys; track key) {
          <mat-option [value]="+key">{{ skillList[+key] }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Categories</mat-label>
        <mat-select formControlName="categories" multiple>
          @for (key of categoryKeys; track key) {
          <mat-option [value]="+key">{{ categoryList[+key] }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Ages</mat-label>
        <mat-select formControlName="ages" multiple>
          @for (key of ageKeys; track key) {
          <mat-option [value]="+key">{{ ageList[+key] }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Supplies</mat-label>
        <mat-select formControlName="supplies" multiple>
          @for (key of supplyKeys; track key) {
          <mat-option [value]="+key">{{ supplyList[+key] }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

        <mat-label>Wheelchair Accessible?</mat-label>
        <mat-checkbox formControlName="wheelchair_accessible" class="ms-2">
        </mat-checkbox>

      <!-- Location Information Section -->
      <div class="section-label">
        <h3>Location Information</h3>
        <p class="helper-text">
          Enter a location address and coordinates will be automatically
          generated, or click the map pin icon to manually trigger geocoding.
        </p>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Location Name</mat-label>
          <input
                  matInput
                  formControlName="location_name"
                  placeholder="e.g., Community Center, Main Campus"
                  required
          />
          @if (projectForm.get("location_name")?.hasError("required")) {
          <mat-error>Location name is required</mat-error>
          }
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="location-field">
          <mat-label>Location Address</mat-label>
          <input
                  matInput
                  formControlName="location_address"
                  placeholder="e.g., 123 Main St, San Francisco, CA"
                  required
          />
          @if (projectForm.get("location_address")?.value && !geocoding) {
          <button
                  type="button"
                  matSuffix
                  mat-icon-button
                  (click)="geocodeLocation(projectForm.get('location_address')?.value)"
                  aria-label="Geocode address"
                  matTooltip="Find coordinates for this address"
          >
            <mat-icon>pin_drop</mat-icon>
          </button>
          }
          @if (geocoding) {
          <mat-spinner matSuffix diameter="20"> </mat-spinner>
          }
          @if (projectForm.get("location_name")?.hasError("required")) {
          <mat-error> Location Name is required </mat-error>
          }
        </mat-form-field>
      </div>

      <div class="form-row coordinates-row">
        <mat-form-field appearance="outline">
          <mat-label>Latitude</mat-label>
          <input
                  matInput
                  required
                  formControlName="latitude"
                  placeholder="e.g., 37.7749"
          />
          @if (projectForm.get("latitude")?.hasError("pattern")) {
          <mat-error> Please enter a valid latitude value </mat-error>
          }
          @if (projectForm.get("latitude")?.hasError("required")) {
          <mat-error> Latitude is required </mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Longitude</mat-label>
          <input
                  matInput
                  required
                  formControlName="longitude"
                  placeholder="e.g., -122.4194"
          />
          @if (projectForm.get("longitude")?.hasError("pattern")) {
          <mat-error> Please enter a valid longitude value </mat-error>
          }
          @if (projectForm.get("longitude")?.hasError("required")) {
          <mat-error> Longitude is required </mat-error>
          }
        </mat-form-field>
      </div>
    </mat-dialog-content>

    <mat-dialog-actions align="end">
      <button mat-button mat-dialog-close [disabled]="submitting">
        Cancel
      </button>
      <button
              mat-raised-button
              color="primary"
              type="submit"
              [disabled]="projectForm.invalid || submitting"
      >
        <mat-icon>save</mat-icon>
        @if (!submitting) {
        <span>{{ data.isEdit ? "Update" : "Create" }}</span>
        }
        @if (submitting) {
        <span>Saving...</span>
        }
      </button>
    </mat-dialog-actions>
  </form>
  }
</div>
