<div class="project-detail-container">
  @if (isLoading) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading project details...</p>
    </div>
  }
  
  <!-- Registration Dialog Template -->
  <ng-template #registrationDialog>
    <div class="registration-dialog">
      <h2 mat-dialog-title>Register for {{project?.title}}</h2>
      
      <mat-dialog-content>
        <p>Please complete your registration details:</p>
        
        <form #registrationForm="ngForm">
          <mat-form-field class="full-width">
            <mat-label>Number of guests</mat-label>
            <input matInput 
                  type="number" 
                  min="0" 
                  max="10"
                  [(ngModel)]="guestCount" 
                  name="guestCount">
            <mat-hint>Enter the number of guests you'll bring (0-10)</mat-hint>
          </mat-form-field>
          
          <mat-checkbox [(ngModel)]="isProjectLead" name="isProjectLead" class="project-lead-checkbox">
            Register as a project lead
          </mat-checkbox>
          
          <p class="lead-description">
            Project leads help coordinate activities and may receive additional instructions 
            before the project starts.
          </p>
        </form>
      </mat-dialog-content>
      
      <mat-dialog-actions align="end">
        <button mat-button mat-dialog-close>Cancel</button>
        <button mat-raised-button 
                color="primary" 
                [disabled]="loadingRegistration"
                (click)="registerForProject()">
          @if (!loadingRegistration) {
            <span>Complete Registration</span>
          }
          @if (loadingRegistration) {
            <span>Processing...</span>
          }
        </button>
      </mat-dialog-actions>
    </div>
  </ng-template>

  @if (!isLoading && project) {
    <mat-card class="project-card">
      <mat-card-header>
        <mat-card-title>{{project.title}}</mat-card-title>
        <mat-card-subtitle>
          @if (getDaysUntilStart() > 0) {
            <span>
              Starting in {{getDaysUntilStart()}} days ({{formatDate(project.projectDate)}})
            </span>
          }
          @if (getDaysUntilStart() === 0) {
            <span>
              Starting today!
            </span>
          }
          @if (getDaysUntilStart() < 0) {
            <span>
              Started {{-getDaysUntilStart()}} days ago
            </span>
          }
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="project-dates">
          <div class="date-field">
            <strong>Date:</strong> {{formatDate(project.projectDate)}}
          </div>
          <div class="date-field">
            <strong>Time:</strong> {{formatTime(project.startTime)}} - {{formatTime(project.endTime)}}
          </div>
        </div>

        <div class="project-capacity">
          <h3>Registration Capacity</h3>
          <div class="capacity-indicator">
            <div class="capacity-bar-container">
              <div class="capacity-bar" 
                   [ngClass]="{'available': getCapacityPercentage() < 50, 
                              'filling': getCapacityPercentage() >= 50 && getCapacityPercentage() < 80,
                              'almost-full': getCapacityPercentage() >= 80 && getCapacityPercentage() < 100,
                              'full': getCapacityPercentage() >= 100}"
                   [style.width.%]="getCapacityPercentage()"></div>
            </div>
            <span class="capacity-text">
              {{project.currentRegistrations}} / {{project.maxCapacity}} spots filled
            </span>
          </div>
        </div>

        <div class="project-description">
          <h3>Description</h3>
          <p>{{project.description}}</p>
        </div>

        <!-- Location Section - Only shown if location is provided -->
        @if (project.locationName || (project.latitude && project.longitude)) {
          <div class="project-location">
            <h3>Location</h3>
            @if (project.locationName) {
              <p><strong>Location:</strong> {{project.locationName}}</p>
            }
            
            @if (project.latitude && project.longitude) {
              <!-- Google Maps component -->
              <div class="map-container">
                <google-map [options]="mapOptions" height="300px" width="100%">
                  @if (markerPosition) {
                    <map-marker [position]="markerPosition" [options]="markerOptions"></map-marker>
                  }
                </google-map>
              </div>
              
              <div class="map-actions">
                <a href="https://maps.google.com/?q={{project.latitude}},{{project.longitude}}" 
                   target="_blank" 
                   mat-raised-button 
                   color="accent">
                  <mat-icon>directions</mat-icon> Get Directions
                </a>
              </div>
            }
          </div>
        }

        <div class="registration-status">
          @if (isRegistered) {
            <div class="registered-message">
              <mat-icon color="primary">check_circle</mat-icon>
              <span>You are registered for this project</span>
            </div>
          }
          
          @if (registrationError) {
            <div class="error-message">
              <mat-icon color="warn">error</mat-icon>
              <span>{{registrationError}}</span>
            </div>
          }
        </div>
      </mat-card-content>

      <mat-card-actions align="end">
        <button mat-button color="accent" routerLink="/projects">
          <mat-icon>arrow_back</mat-icon> Back to Projects
        </button>
        
        @if (!isRegistered) {
          <button mat-raised-button 
                  color="primary" 
                  (click)="openRegistrationForm()" 
                  [disabled]="loadingRegistration || isProjectFull()">
            <mat-icon>event_available</mat-icon>
            <span>Register</span>
          </button>
        }
        
        @if (isRegistered) {
          <button mat-raised-button 
                  color="warn" 
                  (click)="cancelRegistration()" 
                  [disabled]="loadingRegistration">
            <mat-icon>event_busy</mat-icon>
            @if (!loadingRegistration) {
              <span>Cancel Registration</span>
            }
            @if (loadingRegistration) {
              <span>Cancelling...</span>
            }
          </button>
        }
      </mat-card-actions>
    </mat-card>

    <!-- Admin Panel - Only visible to admins -->
    @if (isAdmin) {
      <mat-card class="admin-panel">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>admin_panel_settings</mat-icon>
            Admin Panel - Registrations
          </mat-card-title>
        </mat-card-header>
        
        <mat-card-content>
          @if (registrations.length === 0) {
            <div class="no-registrations">
              <p>No registrations found for this project.</p>
            </div>
          }
          
          @if (registrations.length > 0) {
            <div class="registrations-list">
              <h3>Registered Users ({{registrations.length}})</h3>
              
              <mat-list>
                @for (reg of registrations; track reg.id) {
                  <mat-list-item>
                    <img matListAvatar [src]="reg.user?.picture || 'assets/default-avatar.png'" alt="User avatar">
                    <div matLine>
                      {{reg.user?.name}}
                      @if (reg.isProjectLead) {
                        <span class="project-lead-badge">Project Lead</span>
                      }
                    </div>
                    <div matLine>{{reg.user?.email}}</div>
                    <div matLine>Status: <strong>{{reg.status}}</strong></div>
                    <div matLine>
                      Registered on: {{formatDate(reg.createdAt)}}
                      @if (reg.guestCount > 0) {
                        <span class="guest-badge">+{{reg.guestCount}} guests</span>
                      }
                    </div>
                  </mat-list-item>
                }
              </mat-list>
            </div>
          }
        </mat-card-content>
      </mat-card>
    }
  }

  @if (!isLoading && !project) {
    <div class="error-container">
      <mat-icon color="warn">error</mat-icon>
      <h2>Project Not Found</h2>
      <p>The project you're looking for doesn't exist or has been removed.</p>
      <button mat-raised-button color="primary" routerLink="/projects">
        Browse Available Projects
      </button>
    </div>
  }
</div>
