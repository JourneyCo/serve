<div class="profile-container">
  @if (loading) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading profile...</p>
    </div>
  }

  @if (!loading && user) {
    <mat-card class="profile-card">
      <mat-card-header>
        <div
          mat-card-avatar
          class="profile-avatar"
          [style.background-image]="'url(' + user.picture + ')'"
        ></div>
        <mat-card-title>{{ user.firstName }} {{ user.lastName }}</mat-card-title>
        <mat-card-subtitle>{{ user.email }}</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="user-details">
          <div class="detail-item">
            <span class="label">Account ID:</span>
            <span class="value">{{ user.id }}</span>
          </div>

          <div class="detail-item">
            <span class="label">Member Since:</span>
            <span class="value">{{ user.createdAt | date: "medium" }}</span>
          </div>

          @if (user.isAdmin) {
            <div class="admin-badge"><mat-icon>security</mat-icon> Admin</div>
          }
        </div>
      </mat-card-content>

      <mat-card-actions align="end">
        <button mat-raised-button color="primary" routerLink="/projects">
          <mat-icon>event_available</mat-icon> Browse Projects
        </button>

        @if (user.isAdmin) {
          <button mat-raised-button color="accent" routerLink="/admin">
            <mat-icon>admin_panel_settings</mat-icon> Admin Dashboard
          </button>
        }
      </mat-card-actions>
    </mat-card>

    <div class="registrations-section">
      <h2>My Registrations</h2>

      @if (registrationsDataSource.data.length === 0) {
        <div class="no-registrations">
          <mat-icon>event_busy</mat-icon>
          <p>You haven't registered for any projects yet.</p>
          <button mat-raised-button color="primary" routerLink="/projects">
            Browse Available Projects
          </button>
        </div>
      }

      @if (registrationsDataSource.data.length > 0) {
        <div class="registrations-table">
          <table mat-table [dataSource]="registrationsDataSource">
            <!-- Project Title Column -->
            <ng-container matColumnDef="projectTitle">
              <th mat-header-cell *matHeaderCellDef>Project</th>
              <td mat-cell *matCellDef="let reg">{{ reg.project?.title }}</td>
            </ng-container>

            <!-- Start Date Column -->
            <ng-container matColumnDef="startDate">
              <th mat-header-cell *matHeaderCellDef>Start Date</th>
              <td mat-cell *matCellDef="let reg">
                {{ reg.project?.startDate | date: "medium" }}
                @if (getDaysUntilStart(reg.project?.startDate) > 0) {
                  <div class="days-info">
                    (in {{ getDaysUntilStart(reg.project?.startDate) }} days)
                  </div>
                }
                @if (getDaysUntilStart(reg.project?.startDate) <= 0) {
                  <div class="days-info started">(started)</div>
                }
              </td>
            </ng-container>

            <!-- End Date Column -->
            <ng-container matColumnDef="endDate">
              <th mat-header-cell *matHeaderCellDef>End Date</th>
              <td mat-cell *matCellDef="let reg">
                {{ reg.project?.endDate | date }}
              </td>
            </ng-container>

            <!-- Location Column -->
            <ng-container matColumnDef="location">
              <th mat-header-cell *matHeaderCellDef>Location</th>
              <td mat-cell *matCellDef="let reg">
                @if (reg.project?.locationName) {
                  <span class="location-info">
                    <mat-icon class="location-icon">location_on</mat-icon>
                    {{ reg.project.locationName }}
                  </span>
                }
                @if (!reg.project?.locationName) {
                  <span class="no-location">Not specified</span>
                }
              </td>
            </ng-container>

            <!-- Registration Details Column -->
            <ng-container matColumnDef="details">
              <th mat-header-cell *matHeaderCellDef>Details</th>
              <td mat-cell *matCellDef="let reg">
                @if (reg.isProjectLead) {
                  <span class="detail-badge lead">Project Lead</span>
                }
                @if (reg.guestCount > 0) {
                  <span class="detail-badge guests"
                    >+{{ reg.guestCount }} Guests</span
                  >
                }
                @if (!reg.isProjectLead && reg.guestCount == 0) {
                  <span class="detail-badge">Participant</span>
                }
              </td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let reg">
                <span class="status-badge" [ngClass]="reg.status">{{
                  reg.status
                }}</span>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let reg">
                <button
                  mat-icon-button
                  color="primary"
                  [routerLink]="['/projects', reg.projectId]"
                  matTooltip="View Project"
                >
                  <mat-icon>info</mat-icon>
                </button>

                @if (
                  reg.status === "registered" &&
                  getDaysUntilStart(reg.project?.startDate) > 0
                ) {
                  <button
                    mat-icon-button
                    color="warn"
                    (click)="cancelRegistration(reg.projectId)"
                    [disabled]="registrationLoading"
                    matTooltip="Cancel Registration"
                  >
                    <mat-icon>event_busy</mat-icon>
                  </button>
                }
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="registrationsColumns"></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: registrationsColumns"
            ></tr>
          </table>
        </div>
      }
    </div>
  }

  @if (!loading && !user) {
    <div class="error-container">
      <mat-icon color="warn">error</mat-icon>
      <h2>Error Loading Profile</h2>
      <p>
        We were unable to load your profile information. Please try again later.
      </p>
    </div>
  }
</div>
